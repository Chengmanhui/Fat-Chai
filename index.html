<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LifeTracker for Fat Boy</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; -webkit-tap-highlight-color: transparent; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
    </style>
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@19.0.0",
        "react-dom": "https://esm.sh/react-dom@19.0.0",
        "react-dom/client": "https://esm.sh/react-dom@19.0.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.344.0?external=react,react-dom",
        "recharts": "https://esm.sh/recharts@2.15.0?external=react,react-dom",
        "react-dom/": "https://esm.sh/react-dom@19.0.0/",
        "react/": "https://esm.sh/react@19.0.0/"
      }
    }
    </script>
</head>
<body class="text-slate-800">
    <div id="root" class="flex-1 w-full min-h-screen flex flex-col"></div>

    <script type="text/babel" data-type="module" data-presets="react,typescript">
        import React, { useState, useEffect, useCallback, useMemo, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import { Activity, Apple, Wallet, BarChart2, Landmark, Home, Plus, Trash2, Check, X, Clock, Zap, PoundSterling, Coins, Droplets, Minus, Settings, Edit2, Save } from 'lucide-react';
        import { CartesianGrid, Line, LineChart, ResponsiveContainer, Tooltip, XAxis, YAxis } from 'recharts';

        // --- TYPES & CONSTANTS ---

        const SauceAmount = {
          NONE: 'None',
          LITTLE: 'Little',
          MODERATE: 'Moderate',
          LARGE: 'Large',
        };

        const Currency = {
          HKD: 'HKD',
          GBP: 'GBP',
        };

        const TransactionType = {
          INCOME: 'Income',
          EXPENSE: 'Expense',
        };

        const EXCHANGE_RATE_HKD_TO_GBP = 0.1;

        // --- HOOKS ---

        function useStorage(key, initialValue) {
          const [storedValue, setStoredValue] = useState(() => {
            if (typeof window === 'undefined') {
              return initialValue;
            }
            try {
              const item = window.localStorage.getItem(key);
              return item ? JSON.parse(item) : initialValue;
            } catch (error) {
              console.warn(`Error reading localStorage key â€œ${key}â€:`, error);
              return initialValue;
            }
          });

          const setValue = useCallback((value) => {
            setStoredValue((currentValue) => {
              try {
                const valueToStore = value instanceof Function ? value(currentValue) : value;
                if (typeof window !== 'undefined') {
                  window.localStorage.setItem(key, JSON.stringify(valueToStore));
                }
                return valueToStore;
              } catch (error) {
                console.warn(`Error setting localStorage key â€œ${key}â€:`, error);
                return currentValue;
              }
            });
          }, [key]);

          useEffect(() => {
            const handleStorageChange = (e) => {
              if (e.key === key && e.newValue !== null) {
                try {
                  setStoredValue(JSON.parse(e.newValue));
                } catch (error) {
                  console.warn(`Error parsing storage change for key â€œ${key}â€:`, error);
                }
              }
            };

            window.addEventListener('storage', handleStorageChange);
            return () => window.removeEventListener('storage', handleStorageChange);
          }, [key]);

          return [storedValue, setValue];
        }

        // --- COMPONENTS ---

        const Layout = ({ children, activeTab, onTabChange, alert }) => {
          const tabs = [
            { id: 'summary', icon: Home, label: 'Home' },
            { id: 'weight', icon: Activity, label: 'Weight' },
            { id: 'diet', icon: Apple, label: 'Diet' },
            { id: 'exercise', icon: BarChart2, label: 'Exercise' },
            { id: 'money', icon: Wallet, label: 'Money' },
            { id: 'bank', icon: Landmark, label: 'Bank' },
          ];

          return (
            <div className="flex flex-col min-h-screen bg-slate-50 text-slate-800">
              <header className="sticky top-0 z-50 bg-white/80 backdrop-blur-md border-b border-pink-100 shadow-sm">
                <div className="max-w-md mx-auto px-4 py-4 flex justify-between items-center">
                  <button 
                    onClick={() => onTabChange('summary')}
                    className="text-xl font-bold bg-gradient-to-r from-pink-400 to-sky-400 bg-clip-text text-transparent hover:opacity-80 transition-opacity focus:outline-none"
                  >
                    LifeTracker
                  </button>
                  <button 
                    onClick={() => onTabChange('summary')}
                    className="w-8 h-8 rounded-full bg-gradient-to-br from-pink-200 to-sky-200 flex items-center justify-center text-xs font-bold text-white shadow-inner hover:scale-105 transition-transform focus:outline-none"
                  >
                    FB
                  </button>
                </div>
                {alert && (
                  <div className="bg-red-500 text-white px-4 py-2 text-sm text-center animate-pulse">
                    {alert}
                  </div>
                )}
              </header>

              <main className="flex-1 w-full max-w-md mx-auto p-4 pb-24">
                {children}
              </main>

              <nav className="fixed bottom-0 left-0 right-0 bg-white border-t border-sky-100 pb-safe z-40">
                <div className="max-w-md mx-auto flex justify-around items-center h-16 px-1">
                  {tabs.map((tab) => (
                    <button
                      key={tab.id}
                      onClick={() => onTabChange(tab.id)}
                      className={`flex flex-col items-center justify-center w-full h-full transition-colors ${
                        activeTab === tab.id
                          ? 'text-sky-500'
                          : 'text-slate-400 hover:text-sky-300'
                      }`}
                    >
                      <tab.icon size={20} strokeWidth={activeTab === tab.id ? 2.5 : 2} />
                      <span className="text-[10px] mt-1 font-medium truncate max-w-full px-1">{tab.label}</span>
                    </button>
                  ))}
                </div>
              </nav>
            </div>
          );
        };

        const MoneyVisualization = ({ transactions, currentMonth, currentYear, viewMode, expenseCategories }) => {
          const canvasRef = useRef(null);

          // Color Palettes
          const vaseColors = {
              green: { outline: '#14532d', body: '#dcfce7', dot: '#86efac', inside: '#4ade80', text: '#166534' },
              yellow: { outline: '#713f12', body: '#fef9c3', dot: '#fde047', inside: '#facc15', text: '#854d0e' },
              red: { outline: '#7f1d1d', body: '#fee2e2', dot: '#fca5a5', inside: '#f87171', text: '#991b1b' }
          };

          const getVaseColor = (amount, warning, danger) => {
              if (amount >= danger) return vaseColors.red;
              if (amount >= warning) return vaseColors.yellow;
              return vaseColors.green;
          };

          useEffect(() => {
            const canvas = canvasRef.current;
            if (!canvas) return;

            const ctx = canvas.getContext('2d');
            if (!ctx) return;

            // Filter transactions
            const filteredTransactions = transactions.filter(t => {
              const d = new Date(t.date);
              if (viewMode === 'month') {
                return d.getMonth() === currentMonth && d.getFullYear() === currentYear;
              } else {
                return d.getFullYear() === currentYear;
              }
            });

            let totalIncome = 0;
            const expensesByCategory = {};
            // Initialize with custom categories
            expenseCategories.forEach(c => expensesByCategory[c.name] = 0);

            filteredTransactions.forEach(t => {
               const amountGBP = t.originalCurrency === 'HKD' ? t.originalAmount * 0.1 : t.originalAmount; 
               if (t.type === TransactionType.INCOME) {
                   totalIncome += amountGBP;
               } else {
                   // Handle if category was deleted or renamed (fallback bucket?)
                   // For now, only sum if category exists, or create on fly? 
                   // Better to only sum known. If category missing from config, it might be hidden, 
                   // but let's initialize if it exists in transaction history
                   if (expensesByCategory[t.category] === undefined) {
                      expensesByCategory[t.category] = 0;
                   }
                   expensesByCategory[t.category] += amountGBP;
               }
            });

            const totalExpense = Object.values(expensesByCategory).reduce((a, b) => a + b, 0);

            // Setup Canvas
            const width = canvas.width = canvas.offsetWidth;
            const height = canvas.height = 400;

            // Use dynamic categories that have > 0 expense OR are in the list
            // We'll use the provided expenseCategories list for ordering and config
            const activeCats = expenseCategories.map(c => c.name);
            // Also include any categories found in transactions that aren't in config (legacy data)
            Object.keys(expensesByCategory).forEach(c => {
               if (!activeCats.includes(c)) activeCats.push(c);
            });

            const VASES = activeCats;
            const PADDING = 15;
            const TOTAL_WIDTH = width - (PADDING * 2);
            const VASE_SLOT_WIDTH = TOTAL_WIDTH / Math.max(1, VASES.length);
            
            // Determine Scale for Droplets
            const maxVal = Math.max(totalIncome, totalExpense);
            let DYNAMIC_DROPLET_VALUE = 1;
            if (maxVal > 20000) DYNAMIC_DROPLET_VALUE = 50;
            else if (maxVal > 10000) DYNAMIC_DROPLET_VALUE = 20;
            else if (maxVal > 5000) DYNAMIC_DROPLET_VALUE = 10;
            else if (maxVal > 1000) DYNAMIC_DROPLET_VALUE = 5;
            else DYNAMIC_DROPLET_VALUE = 1;

            // Physics Constants
            const PARTICLE_RADIUS = 2.5;
            const PACKING_SPACING = PARTICLE_RADIUS * 2;
            const TAP_X = width / 2;
            const TAP_Y = 40;
            const DROPLET_COLOR = '#3b82f6';
            
            let particles = [];

            // --- LOGIC: Distribute Income into Vases ---
            
            const maxCategoryExpense = Math.max(...Object.values(expensesByCategory));
            const vaseConfig = {};
            
            VASES.forEach((cat, i) => {
                const expense = expensesByCategory[cat] || 0;
                let h = 0;
                if (maxCategoryExpense > 0 && expense > 0) {
                     h = 40 + ((expense / maxCategoryExpense) * 140);
                } else if (expense === 0) {
                     h = 0; 
                }

                const w = Math.min(60, VASE_SLOT_WIDTH * 0.85); // Cap max width for aesthetics
                const x = PADDING + (i * VASE_SLOT_WIDTH) + (VASE_SLOT_WIDTH - w)/2;
                const y = height - 30; 

                const capacityDroplets = Math.ceil(expense / DYNAMIC_DROPLET_VALUE);
                
                // Find thresholds
                const catConfig = expenseCategories.find(c => c.name === cat);
                const warning = catConfig ? catConfig.warning : 1000;
                const danger = catConfig ? catConfig.danger : 2000;
                const colorTheme = getVaseColor(expense, warning, danger);

                vaseConfig[cat] = {
                    x, y, w, h,
                    capacityDroplets,
                    fillDroplets: 0,
                    colorTheme
                };
            });

            const fillRatio = totalExpense > 0 ? Math.min(1.0, totalIncome / totalExpense) : 1.0;
            let allocatedDroplets = 0;

            VASES.forEach(cat => {
                const config = vaseConfig[cat];
                if (config.capacityDroplets > 0) {
                    const allocate = Math.floor(config.capacityDroplets * fillRatio);
                    config.fillDroplets = allocate;
                    allocatedDroplets += allocate;
                }
            });

            const totalIncomeDroplets = Math.floor(totalIncome / DYNAMIC_DROPLET_VALUE);
            const overflowDroplets = Math.max(0, totalIncomeDroplets - allocatedDroplets);

            // Generate Particles
            VASES.forEach((cat, i) => {
                const config = vaseConfig[cat];
                if (config.h === 0 || config.fillDroplets === 0) return;

                const count = config.fillDroplets;
                const safeCount = Math.min(count, 800); 

                const vaseInnerWidth = config.w * 0.8; 
                const itemsPerRow = Math.max(1, Math.floor(vaseInnerWidth / PACKING_SPACING));
                const centerX = config.x + config.w/2;
                const bottomY = config.y - 5; 
                const topRimY = config.y - config.h;

                for (let j = 0; j < safeCount; j++) {
                    const row = Math.floor(j / itemsPerRow);
                    const col = j % itemsPerRow;
                    
                    const itemsInThisRow = Math.min(safeCount - row * itemsPerRow, itemsPerRow);
                    const rowWidth = (itemsInThisRow - 1) * PACKING_SPACING;
                    const xStart = centerX - (rowWidth / 2);
                    
                    const finalX = xStart + (col * PACKING_SPACING);
                    const finalY = bottomY - (row * PACKING_SPACING) - PARTICLE_RADIUS;
                    
                    if (finalY < topRimY + PARTICLE_RADIUS) break;
                    
                    particles.push({
                        x: TAP_X,
                        y: TAP_Y + 10,
                        vx: (Math.random() - 0.5) * 4 + (finalX - TAP_X) * 0.015,
                        vy: Math.random() * 2,
                        r: PARTICLE_RADIUS,
                        color: DROPLET_COLOR,
                        settled: false,
                        finalX: finalX,
                        finalY: finalY,
                        delay: j + (i * 10) 
                    });
                }
            });

            if (overflowDroplets > 0) {
                const safeOverflow = Math.min(overflowDroplets, 1000);
                const floorY = height - 30; 
                const spreadW = width * 0.95;
                const centerX = width / 2;
                
                for (let j = 0; j < safeOverflow; j++) {
                     const finalX = (Math.random() * spreadW) + (centerX - spreadW/2);
                     const finalY = floorY - Math.random() * 8; 

                     particles.push({
                        x: TAP_X,
                        y: TAP_Y + 15,
                        vx: (Math.random() - 0.5) * 8, 
                        vy: Math.random() * 3,
                        r: PARTICLE_RADIUS,
                        color: DROPLET_COLOR,
                        settled: false,
                        finalX: finalX,
                        finalY: finalY,
                        delay: 100 + j 
                    });
                }
            }

            let animationFrameId;
            let frameCount = 0;

            const render = () => {
              frameCount++;
              ctx.clearRect(0, 0, width, height);

              // Floor
              ctx.beginPath();
              ctx.moveTo(0, height - 30);
              ctx.lineTo(width, height - 30);
              ctx.strokeStyle = '#cbd5e1';
              ctx.lineWidth = 2;
              ctx.stroke();

              // Draw Vases (Background)
              VASES.forEach(cat => {
                  const config = vaseConfig[cat];
                  if (config.h > 0) {
                      drawVase(ctx, config.x, config.y, config.w, config.h, config.colorTheme);
                  }
              });

              // Draw Particles
              particles.forEach(p => {
                if (frameCount < p.delay) return;

                if (!p.settled) {
                  p.vy += 0.25; 
                  p.x += p.vx;
                  p.y += p.vy;

                  const dx = p.finalX - p.x;
                  p.vx += dx * 0.01;
                  p.vx *= 0.95;

                  if (p.y >= p.finalY) {
                    p.y = p.finalY;
                    p.x = p.finalX;
                    p.settled = true;
                  }
                }
                drawCartoonDroplet(ctx, p.x, p.y, p.r, p.color);
              });

              // Tap
              drawCartoonTap(ctx, TAP_X, TAP_Y);

              // Draw Labels
              VASES.forEach(cat => {
                  const config = vaseConfig[cat];
                  if (config.h > 0) {
                      drawVaseLabel(ctx, config.x, config.y, config.w, config.h, cat, expensesByCategory[cat] || 0, config.colorTheme);
                  } else {
                     ctx.fillStyle = '#94a3b8';
                     ctx.font = '9px Inter';
                     ctx.textAlign = 'center';
                     ctx.fillText(cat, config.x + config.w/2, height - 15);
                     ctx.fillText('Â£0', config.x + config.w/2, height - 5);
                  }
              });

              ctx.fillStyle = '#64748b';
              ctx.font = '10px Inter';
              ctx.textAlign = 'right';
              ctx.fillText(`1 Drop â‰ˆ Â£${DYNAMIC_DROPLET_VALUE}`, width - 20, 20);
              
              ctx.textAlign = 'left';
              ctx.font = 'bold 12px Inter';
              ctx.fillStyle = '#059669'; 
              ctx.fillText(`Income: Â£${totalIncome.toFixed(0)}`, 20, 20);
              ctx.fillStyle = '#dc2626'; 
              ctx.fillText(`Expense: Â£${totalExpense.toFixed(0)}`, 20, 36);

              animationFrameId = requestAnimationFrame(render);
            };

            render();
            return () => cancelAnimationFrame(animationFrameId);
          }, [transactions, currentMonth, currentYear, viewMode, expenseCategories]);

          const drawVase = (ctx, x, bottomY, w, h, theme) => {
            const cx = x + w / 2;
            const topY = bottomY - h;
            
            ctx.save();
            ctx.lineJoin = 'round';
            ctx.lineCap = 'round';
            ctx.lineWidth = 2;
            ctx.strokeStyle = theme.outline;

            const rimW = w * 0.7;
            const neckW = w * 0.45;
            const bodyW = w * 0.95;
            const baseW = w * 0.6;
            
            const rimY = topY;
            const neckStartY = topY + h * 0.15;
            const bodyWidestY = topY + h * 0.6;
            const baseY = bottomY;

            ctx.beginPath();
            ctx.moveTo(cx - rimW/2, rimY);
            ctx.quadraticCurveTo(cx - rimW/2, neckStartY, cx - neckW/2, neckStartY); 
            ctx.quadraticCurveTo(cx - bodyW, bodyWidestY, cx - baseW/2, baseY); 
            ctx.lineTo(cx + baseW/2, baseY); 
            ctx.quadraticCurveTo(cx + bodyW, bodyWidestY, cx + neckW/2, neckStartY); 
            ctx.quadraticCurveTo(cx + rimW/2, neckStartY, cx + rimW/2, rimY); 
            ctx.closePath();

            ctx.fillStyle = theme.body;
            ctx.fill();

            ctx.save();
            ctx.clip();
            ctx.fillStyle = theme.dot;
            const spacing = 5;
            for(let py = topY; py < bottomY; py += spacing) {
                const off = (Math.floor(py/spacing)%2)*(spacing/2);
                for(let px = x - w; px < x + w*2; px+=spacing) {
                    ctx.beginPath();
                    ctx.arc(px+off, py, 1.5, 0, Math.PI*2);
                    ctx.fill();
                }
            }
            ctx.restore();
            ctx.stroke();

            ctx.beginPath();
            ctx.ellipse(cx, rimY, rimW/2, 4, 0, 0, Math.PI*2);
            ctx.fillStyle = theme.inside;
            ctx.fill();
            ctx.stroke();

            ctx.restore();
          };

          const drawVaseLabel = (ctx, x, bottomY, w, h, label, amount, theme) => {
            const cx = x + w / 2;
            const topY = bottomY - h;

            ctx.save();
            
            ctx.fillStyle = '#475569';
            ctx.font = '600 9px Inter';
            ctx.textAlign = 'center';
            
            const labelY = bottomY + 12;
            const words = label.split(' ');
            if (words.length > 1 && w < 50) {
                ctx.fillText(words[0], cx, labelY);
                ctx.fillText(words[1], cx, labelY + 9);
            } else {
                ctx.fillText(label, cx, labelY);
            }

            ctx.font = 'bold 9px Inter';
            const amountText = `Â£${amount.toFixed(0)}`;
            
            const textMetrics = ctx.measureText(amountText);
            const bgH = 14;
            const bgW = textMetrics.width + 10;
            
            ctx.fillStyle = 'rgba(255, 255, 255, 0.9)';
            ctx.beginPath();
            ctx.roundRect(cx - bgW/2, topY - 10 - bgH + 3, bgW, bgH, 4);
            ctx.fill();

            ctx.fillStyle = theme.text; 
            ctx.fillText(amountText, cx, topY - 10);

            ctx.restore();
          };

          const drawCartoonTap = (ctx, x, y) => {
              ctx.save();
              ctx.translate(x, y);
              const scale = 0.8;
              ctx.scale(scale, scale);
              const outlineColor = '#0f172a';
              ctx.fillStyle = '#fbbf24'; 
              ctx.strokeStyle = outlineColor;
              ctx.lineWidth = 2;
              ctx.beginPath(); ctx.ellipse(-30, 0, 10, 25, 0, 0, Math.PI * 2); ctx.fill(); ctx.stroke();
              ctx.fillStyle = '#cbd5e1'; 
              ctx.beginPath(); ctx.moveTo(-30, -10); ctx.lineTo(0, -10); ctx.quadraticCurveTo(20, -10, 20, 10);
              ctx.lineTo(20, 25); ctx.lineTo(10, 25); ctx.lineTo(10, 10); ctx.quadraticCurveTo(10, 0, -30, 0);
              ctx.closePath(); ctx.fill(); ctx.stroke();
              ctx.fillStyle = '#94a3b8';
              ctx.beginPath(); ctx.rect(10, 22, 10, 6); ctx.fill(); ctx.stroke();
              ctx.fillStyle = '#cbd5e1';
              ctx.beginPath(); ctx.roundRect(-5, -25, 10, 15, 2); ctx.fill(); ctx.stroke();
              ctx.beginPath(); ctx.roundRect(-15, -30, 30, 8, 3); ctx.fill(); ctx.stroke();
              ctx.restore();
          };

          const drawCartoonDroplet = (ctx, x, y, r, color) => {
              ctx.save();
              ctx.translate(x, y);
              ctx.fillStyle = color;
              ctx.beginPath();
              ctx.moveTo(0, -r * 1.5);
              ctx.quadraticCurveTo(r, -r * 0.5, r, r * 0.5);
              ctx.arc(0, r * 0.5, r, 0, Math.PI);
              ctx.quadraticCurveTo(-r, -r * 0.5, 0, -r * 1.5);
              ctx.closePath();
              ctx.fill();
              ctx.restore();
          };

          return (
            <div className="w-full bg-white rounded-3xl overflow-hidden shadow-xl shadow-sky-100 border border-slate-100 mt-4">
              <div className="bg-white px-6 py-4 border-b border-slate-50 flex justify-between items-center">
                <div className="flex items-center gap-2">
                    <div className="p-1.5 bg-green-100 rounded-lg">
                        <div className="w-3 h-3 bg-green-500 rounded-full animate-pulse"></div>
                    </div>
                    <div>
                        <h3 className="text-slate-700 text-xs font-bold uppercase tracking-wider">Cash Flow</h3>
                        <p className="text-[10px] text-slate-400">Income (Water) â†’ Expenses (Vases)</p>
                    </div>
                </div>
                <span className="text-xs font-bold text-slate-500 bg-slate-100 px-3 py-1 rounded-full">
                    {viewMode === 'month' 
                      ? new Date(currentYear, currentMonth).toLocaleString('default', { month: 'short', year: 'numeric' })
                      : currentYear
                    }
                </span>
              </div>
              
              <div className="relative bg-white">
                  <canvas ref={canvasRef} className="w-full h-[400px] block" />
              </div>
            </div>
          );
        };

        const WeightSection = ({ logs, setLogs }) => {
          const [weight, setWeight] = useState('');

          const handleSubmit = (e) => {
            e.preventDefault();
            if (!weight) return;

            const newLog = {
              id: Date.now().toString(),
              date: new Date().toISOString(),
              weight: parseFloat(weight),
            };

            const updated = [newLog, ...logs].sort((a, b) => new Date(b.date).getTime() - new Date(a.date).getTime());
            setLogs(updated);
            setWeight('');
          };

          const handleDelete = (id) => {
            setLogs(logs.filter(l => l.id !== id));
          };

          const handleWeightChange = (e) => {
            const val = e.target.value;
            if (val.includes('-')) return;
            setWeight(val);
          };

          const chartData = [...logs]
            .sort((a, b) => new Date(a.date).getTime() - new Date(b.date).getTime())
            .map(l => ({
              date: new Date(l.date).toLocaleDateString('en-GB', { month: 'short', day: 'numeric' }),
              weight: l.weight
            }))
            .slice(-10); 

          return (
            <div className="space-y-6">
              <div className="bg-white rounded-2xl p-6 shadow-sm border border-pink-100">
                <h2 className="text-lg font-bold text-slate-700 mb-4">Record Weight</h2>
                <form onSubmit={handleSubmit} className="flex gap-3">
                  <div className="relative flex-1">
                    <input
                      type="number"
                      step="0.1"
                      min="0"
                      value={weight}
                      onChange={handleWeightChange}
                      placeholder="0.0"
                      className="w-full pl-4 pr-12 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-pink-300 transition-all"
                    />
                    <span className="absolute right-4 top-1/2 -translate-y-1/2 text-slate-400 font-medium">kg</span>
                  </div>
                  <button
                    type="submit"
                    className="bg-pink-400 hover:bg-pink-500 text-white p-3 rounded-xl transition-colors shadow-lg shadow-pink-200"
                  >
                    <Plus size={24} />
                  </button>
                </form>
              </div>

              {logs.length > 0 && (
                <div className="bg-white rounded-2xl p-6 shadow-sm border border-sky-100">
                   <h3 className="text-md font-semibold text-slate-600 mb-4">Progress</h3>
                   <div className="h-48 w-full">
                     <ResponsiveContainer width="100%" height="100%">
                       <LineChart data={chartData}>
                         <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#f1f5f9" />
                         <XAxis dataKey="date" tick={{fontSize: 10}} tickLine={false} axisLine={false} />
                         <YAxis domain={['dataMin - 2', 'dataMax + 2']} hide />
                         <Tooltip 
                            contentStyle={{borderRadius: '8px', border: 'none', boxShadow: '0 4px 6px -1px rgb(0 0 0 / 0.1)'}}
                         />
                         <Line type="monotone" dataKey="weight" stroke="#f472b6" strokeWidth={3} dot={{r: 4, fill: '#f472b6'}} activeDot={{r: 6}} />
                       </LineChart>
                     </ResponsiveContainer>
                   </div>
                </div>
              )}

              <div className="space-y-3">
                <h3 className="text-sm font-semibold text-slate-500 uppercase tracking-wider ml-1">History</h3>
                {logs.map((log) => (
                  <div key={log.id} className="bg-white p-4 rounded-xl shadow-sm flex justify-between items-center border border-slate-50">
                    <div>
                      <p className="text-lg font-bold text-slate-700">{log.weight} <span className="text-sm font-normal text-slate-400">kg</span></p>
                      <p className="text-xs text-slate-400">{new Date(log.date).toLocaleString()}</p>
                    </div>
                    <button onClick={() => handleDelete(log.id)} className="text-slate-300 hover:text-red-400 transition-colors">
                      <Trash2 size={18} />
                    </button>
                  </div>
                ))}
                {logs.length === 0 && (
                  <p className="text-center text-slate-400 py-8">No records yet. Start tracking!</p>
                )}
              </div>
            </div>
          );
        };

        const DietSection = ({ logs, setLogs }) => {
          const [vegBowls, setVegBowls] = useState(1);
          const [sauce, setSauce] = useState(SauceAmount.MODERATE);
          const [coldDrink, setColdDrink] = useState(false);
          const [sugarDrink, setSugarDrink] = useState(false);

          const handleSubmit = (e) => {
            e.preventDefault();
            const newLog = {
              id: Date.now().toString(),
              date: new Date().toISOString(),
              vegetableBowls: vegBowls,
              sauce,
              hasColdDrink: coldDrink,
              hasSugarDrink: sugarDrink,
            };
            setLogs([newLog, ...logs]);
            setVegBowls(1);
            setSauce(SauceAmount.MODERATE);
            setColdDrink(false);
            setSugarDrink(false);
          };

          const getScoreColor = (log) => {
            let score = 0;
            if (log.vegetableBowls >= 1) score++;
            if (log.sauce === SauceAmount.NONE || log.sauce === SauceAmount.LITTLE) score++;
            if (!log.hasColdDrink) score++;
            if (!log.hasSugarDrink) score++;

            if (score === 4) return 'bg-green-100 border-green-200';
            if (score >= 2) return 'bg-yellow-50 border-yellow-100';
            return 'bg-red-50 border-red-100';
          };

          return (
            <div className="space-y-6">
              <div className="bg-white rounded-2xl p-6 shadow-sm border border-sky-100">
                <h2 className="text-lg font-bold text-slate-700 mb-4">Log Meal</h2>
                <form onSubmit={handleSubmit} className="space-y-5">
                  
                  <div className="space-y-2">
                    <label className="text-sm font-medium text-slate-600">Vegetable Bowls</label>
                    <div className="flex gap-2">
                      {[0, 0.5, 0.75, 1, 2].map(num => (
                        <button
                          key={num}
                          type="button"
                          onClick={() => setVegBowls(num)}
                          className={`flex-1 py-2 rounded-lg text-sm font-bold transition-all ${
                            vegBowls === num
                              ? 'bg-sky-400 text-white shadow-md shadow-sky-200'
                              : 'bg-slate-50 text-slate-500 hover:bg-slate-100'
                          }`}
                        >
                          {num}
                        </button>
                      ))}
                    </div>
                  </div>

                  <div className="space-y-2">
                    <label className="text-sm font-medium text-slate-600">Sauce Amount</label>
                    <div className="grid grid-cols-2 gap-2">
                      {Object.values(SauceAmount).map((s) => (
                        <button
                          key={s}
                          type="button"
                          onClick={() => setSauce(s)}
                          className={`py-2 px-3 rounded-lg text-sm font-medium transition-all ${
                            sauce === s
                              ? 'bg-pink-400 text-white shadow-md shadow-pink-200'
                              : 'bg-slate-50 text-slate-500 hover:bg-slate-100'
                          }`}
                        >
                          {s}
                        </button>
                      ))}
                    </div>
                  </div>

                  <div className="grid grid-cols-2 gap-4">
                    <button
                      type="button"
                      onClick={() => setColdDrink(!coldDrink)}
                      className={`p-3 rounded-xl border-2 transition-all flex items-center justify-center gap-2 ${
                        coldDrink ? 'border-sky-400 bg-sky-50 text-sky-600' : 'border-slate-100 text-slate-400'
                      }`}
                    >
                      Cold Drink
                      {coldDrink ? <Check size={16} /> : <X size={16} />}
                    </button>
                    <button
                      type="button"
                      onClick={() => setSugarDrink(!sugarDrink)}
                      className={`p-3 rounded-xl border-2 transition-all flex items-center justify-center gap-2 ${
                        sugarDrink ? 'border-pink-400 bg-pink-50 text-pink-600' : 'border-slate-100 text-slate-400'
                      }`}
                    >
                      Sugar Drink
                      {sugarDrink ? <Check size={16} /> : <X size={16} />}
                    </button>
                  </div>

                  <button
                    type="submit"
                    className="w-full bg-slate-800 text-white py-3 rounded-xl font-semibold shadow-lg hover:bg-slate-700 transition-colors"
                  >
                    Save Meal
                  </button>
                </form>
              </div>

              <div className="space-y-3">
                <h3 className="text-sm font-semibold text-slate-500 uppercase tracking-wider ml-1">Recent Meals</h3>
                {logs.map((log) => (
                  <div key={log.id} className={`p-4 rounded-xl shadow-sm border ${getScoreColor(log)} flex justify-between items-start`}>
                    <div className="space-y-1">
                      <p className="text-xs text-slate-400">{new Date(log.date).toLocaleString()}</p>
                      <div className="flex flex-wrap gap-2 text-sm text-slate-700">
                        <span className="font-medium bg-white/50 px-2 py-0.5 rounded">ðŸ¥— {log.vegetableBowls} bowls</span>
                        <span className="font-medium bg-white/50 px-2 py-0.5 rounded">ðŸ§‚ {log.sauce}</span>
                      </div>
                      <div className="flex gap-2 mt-1">
                        {log.hasColdDrink && <span className="text-xs bg-sky-100 text-sky-600 px-2 py-0.5 rounded-full">Cold Drink</span>}
                        {log.hasSugarDrink && <span className="text-xs bg-pink-100 text-pink-600 px-2 py-0.5 rounded-full">Sugar Drink</span>}
                        {!log.hasColdDrink && !log.hasSugarDrink && <span className="text-xs bg-green-100 text-green-600 px-2 py-0.5 rounded-full">Healthy Drink Choice</span>}
                      </div>
                    </div>
                    <button onClick={() => setLogs(logs.filter(l => l.id !== log.id))} className="text-slate-300 hover:text-slate-500">
                      <Trash2 size={16} />
                    </button>
                  </div>
                ))}
              </div>
            </div>
          );
        };

        const ExerciseSection = ({ logs, setLogs }) => {
          const [type, setType] = useState('Gym');
          const [intensity, setIntensity] = useState('Medium');
          const [duration, setDuration] = useState('30');
          const [remarks, setRemarks] = useState('');

          const handleSubmit = (e) => {
            e.preventDefault();
            if (!duration) return;

            const newLog = {
              id: Date.now().toString(),
              date: new Date().toISOString(),
              type,
              intensity,
              durationMinutes: parseInt(duration),
              remarks: remarks.trim()
            };

            setLogs([newLog, ...logs]);
            setType('Gym');
            setIntensity('Medium');
            setDuration('30');
            setRemarks('');
          };

          const activityTypes = ['Running', 'Gym', 'Ball Games', 'Swimming', 'Cycling', 'Yoga'];

          return (
            <div className="space-y-6">
               <div className="grid grid-cols-2 gap-4">
                <div className="bg-sky-500 text-white p-4 rounded-2xl shadow-lg shadow-sky-200">
                  <p className="text-sky-100 text-xs font-medium uppercase">Total Time</p>
                  <p className="text-3xl font-bold mt-1">
                    {logs.reduce((acc, curr) => acc + curr.durationMinutes, 0)}
                    <span className="text-sm font-normal text-sky-200 ml-1">mins</span>
                  </p>
                </div>
                <div className="bg-pink-500 text-white p-4 rounded-2xl shadow-lg shadow-pink-200">
                  <p className="text-pink-100 text-xs font-medium uppercase">Sessions</p>
                  <p className="text-3xl font-bold mt-1">
                    {logs.length}
                    <span className="text-sm font-normal text-pink-200 ml-1">count</span>
                  </p>
                </div>
              </div>

              <div className="bg-white rounded-2xl p-6 shadow-sm border border-slate-100">
                <h2 className="text-lg font-bold text-slate-700 mb-4">Log Workout</h2>
                <form onSubmit={handleSubmit} className="space-y-5">
                  
                  <div className="space-y-2">
                    <label className="text-sm font-medium text-slate-600 flex items-center gap-2">
                      <Activity size={16} /> Activity Type
                    </label>
                    <div className="flex flex-wrap gap-2">
                      {activityTypes.map(t => (
                        <button
                          key={t}
                          type="button"
                          onClick={() => setType(t)}
                          className={`px-3 py-1.5 rounded-full text-xs font-semibold border transition-all ${
                            type === t
                              ? 'bg-slate-800 text-white border-slate-800'
                              : 'bg-white text-slate-500 border-slate-200 hover:border-slate-400'
                          }`}
                        >
                          {t}
                        </button>
                      ))}
                    </div>
                  </div>

                  <div className="space-y-2">
                    <label className="text-sm font-medium text-slate-600 flex items-center gap-2">
                      <Zap size={16} /> Intensity
                    </label>
                    <div className="flex bg-slate-100 p-1 rounded-xl">
                      {['Low', 'Medium', 'High'].map((lvl) => (
                        <button
                          key={lvl}
                          type="button"
                          onClick={() => setIntensity(lvl)}
                          className={`flex-1 py-2 rounded-lg text-sm font-bold transition-all ${
                            intensity === lvl
                              ? lvl === 'High' ? 'bg-red-400 text-white shadow-sm' : lvl === 'Medium' ? 'bg-orange-400 text-white shadow-sm' : 'bg-green-400 text-white shadow-sm'
                              : 'text-slate-400 hover:text-slate-600'
                          }`}
                        >
                          {lvl}
                        </button>
                      ))}
                    </div>
                  </div>

                  <div className="space-y-2">
                    <label className="text-sm font-medium text-slate-600 flex items-center gap-2">
                      <Clock size={16} /> Duration (mins)
                    </label>
                    <input
                      type="number"
                      value={duration}
                      onChange={(e) => setDuration(e.target.value)}
                      className="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-sky-300 transition-all"
                    />
                  </div>

                  <div className="space-y-2">
                    <label className="text-sm font-medium text-slate-600 flex items-center gap-2">
                      <Edit2 size={16} /> Remarks (Optional)
                    </label>
                    <input
                      type="text"
                      value={remarks}
                      onChange={(e) => setRemarks(e.target.value)}
                      placeholder="e.g., Felt great today, beat personal best..."
                      className="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-sky-300 transition-all text-sm"
                    />
                  </div>

                  <button
                    type="submit"
                    className="w-full bg-gradient-to-r from-sky-400 to-pink-400 text-white py-3 rounded-xl font-bold shadow-lg shadow-pink-100 hover:opacity-90 transition-opacity"
                  >
                    Log Session
                  </button>
                </form>
              </div>

              <div className="space-y-3">
                {logs.map((log) => (
                  <div key={log.id} className="bg-white p-4 rounded-xl shadow-sm flex justify-between items-center border-l-4 border-l-sky-400">
                    <div>
                      <div className="flex items-center gap-2">
                        <span className="font-bold text-slate-700">{log.type}</span>
                        <span className={`text-[10px] px-2 py-0.5 rounded-full text-white ${
                          log.intensity === 'High' ? 'bg-red-400' : log.intensity === 'Medium' ? 'bg-orange-400' : 'bg-green-400'
                        }`}>{log.intensity}</span>
                      </div>
                      <p className="text-sm text-slate-500 mt-1">{log.durationMinutes} minutes â€¢ {new Date(log.date).toLocaleDateString()}</p>
                      {log.remarks && <p className="text-xs text-slate-400 mt-1 italic">"{log.remarks}"</p>}
                    </div>
                    <button onClick={() => setLogs(logs.filter(l => l.id !== log.id))} className="text-slate-300 hover:text-red-400">
                      <Trash2 size={18} />
                    </button>
                  </div>
                ))}
              </div>
            </div>
          );
        };

        const ManageCategories = ({ expenseCategories, setExpenseCategories, incomeCategories, setIncomeCategories, onClose, transactions }) => {
            const [activeTab, setActiveTab] = useState('expense');
            const [newName, setNewName] = useState('');
            const [newWarning, setNewWarning] = useState('1000');
            const [newDanger, setNewDanger] = useState('2000');

            const handleAddExpense = (e) => {
                e.preventDefault();
                if (!newName) return;
                setExpenseCategories([...expenseCategories, { 
                    id: Date.now().toString(), 
                    name: newName, 
                    warning: parseFloat(newWarning) || 1000, 
                    danger: parseFloat(newDanger) || 2000 
                }]);
                setNewName('');
            };

            const handleAddIncome = (e) => {
                e.preventDefault();
                if (!newName) return;
                setIncomeCategories([...incomeCategories, { id: Date.now().toString(), name: newName }]);
                setNewName('');
            };

            const handleDeleteExpense = (id) => {
                const cat = expenseCategories.find(c => c.id === id);
                if (!cat) return;
                // Check if category is used in transactions
                const isUsed = transactions.some(t => t.type === TransactionType.EXPENSE && t.category === cat.name);
                if (isUsed) {
                    alert(`Cannot delete category "${cat.name}" because it has associated transactions.`);
                    return;
                }
                setExpenseCategories(expenseCategories.filter(c => c.id !== id));
            };

            const handleDeleteIncome = (id) => {
                const cat = incomeCategories.find(c => c.id === id);
                if (!cat) return;
                // Check if category is used in transactions
                const isUsed = transactions.some(t => t.type === TransactionType.INCOME && t.category === cat.name);
                if (isUsed) {
                    alert(`Cannot delete category "${cat.name}" because it has associated transactions.`);
                    return;
                }
                setIncomeCategories(incomeCategories.filter(c => c.id !== id));
            };

            // Simple inline edit could be complex, for now we allow deleting and re-adding, or just editing thresholds
            // Let's allow editing thresholds directly in the list
            const updateThreshold = (id, field, value) => {
                 setExpenseCategories(expenseCategories.map(c => 
                     c.id === id ? { ...c, [field]: parseFloat(value) || 0 } : c
                 ));
            };

            return (
                <div className="fixed inset-0 z-50 bg-white flex flex-col">
                    <div className="p-4 border-b border-slate-100 flex justify-between items-center bg-white/80 backdrop-blur-md">
                        <h2 className="text-lg font-bold text-slate-800">Manage Categories</h2>
                        <button onClick={onClose} className="p-2 bg-slate-100 rounded-full text-slate-500 hover:bg-slate-200">
                            <X size={20} />
                        </button>
                    </div>

                    <div className="flex p-2 gap-2 bg-slate-50">
                        <button onClick={() => setActiveTab('expense')} className={`flex-1 py-2 rounded-lg font-bold text-sm ${activeTab === 'expense' ? 'bg-white shadow text-pink-500' : 'text-slate-400'}`}>Expenses</button>
                        <button onClick={() => setActiveTab('income')} className={`flex-1 py-2 rounded-lg font-bold text-sm ${activeTab === 'income' ? 'bg-white shadow text-green-500' : 'text-slate-400'}`}>Income</button>
                    </div>

                    <div className="flex-1 overflow-y-auto p-4 space-y-4">
                        {activeTab === 'expense' ? (
                            <>
                                <form onSubmit={handleAddExpense} className="bg-slate-50 p-4 rounded-xl space-y-3">
                                    <h3 className="text-xs font-bold uppercase text-slate-400">Add New Expense Category</h3>
                                    <input value={newName} onChange={e => setNewName(e.target.value)} placeholder="Category Name" className="w-full p-2 rounded border border-slate-200 text-sm" />
                                    <div className="flex gap-2">
                                        <div className="flex-1">
                                            <label className="text-[10px] font-bold text-yellow-600">Yellow Limit (Â£)</label>
                                            <input type="number" value={newWarning} onChange={e => setNewWarning(e.target.value)} className="w-full p-2 rounded border border-yellow-200 bg-yellow-50 text-sm" />
                                        </div>
                                        <div className="flex-1">
                                            <label className="text-[10px] font-bold text-red-600">Red Limit (Â£)</label>
                                            <input type="number" value={newDanger} onChange={e => setNewDanger(e.target.value)} className="w-full p-2 rounded border border-red-200 bg-red-50 text-sm" />
                                        </div>
                                    </div>
                                    <button type="submit" className="w-full py-2 bg-slate-800 text-white rounded-lg font-bold text-sm">Add Category</button>
                                </form>

                                <div className="space-y-2">
                                    {expenseCategories.map(cat => (
                                        <div key={cat.id} className="bg-white p-3 rounded-xl border border-slate-100 shadow-sm">
                                            <div className="flex justify-between items-center mb-2">
                                                <span className="font-bold text-slate-700">{cat.name}</span>
                                                <button onClick={() => handleDeleteExpense(cat.id)} className="text-slate-300 hover:text-red-400"><Trash2 size={16} /></button>
                                            </div>
                                            <div className="flex gap-2 text-xs items-center">
                                                <div className="flex-1 flex items-center gap-1 bg-yellow-50 px-2 py-1 rounded border border-yellow-100">
                                                    <div className="w-2 h-2 rounded-full bg-yellow-400"></div>
                                                    <span>&gt;</span>
                                                    <input type="number" value={cat.warning} onChange={e => updateThreshold(cat.id, 'warning', e.target.value)} className="w-12 bg-transparent border-b border-yellow-200 focus:outline-none" />
                                                </div>
                                                <div className="flex-1 flex items-center gap-1 bg-red-50 px-2 py-1 rounded border border-red-100">
                                                    <div className="w-2 h-2 rounded-full bg-red-400"></div>
                                                    <span>&gt;</span>
                                                    <input type="number" value={cat.danger} onChange={e => updateThreshold(cat.id, 'danger', e.target.value)} className="w-12 bg-transparent border-b border-red-200 focus:outline-none" />
                                                </div>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </>
                        ) : (
                            <>
                                <form onSubmit={handleAddIncome} className="bg-slate-50 p-4 rounded-xl space-y-3">
                                    <h3 className="text-xs font-bold uppercase text-slate-400">Add New Income Category</h3>
                                    <input value={newName} onChange={e => setNewName(e.target.value)} placeholder="Category Name" className="w-full p-2 rounded border border-slate-200 text-sm" />
                                    <button type="submit" className="w-full py-2 bg-slate-800 text-white rounded-lg font-bold text-sm">Add Category</button>
                                </form>
                                <div className="space-y-2">
                                    {incomeCategories.map(cat => (
                                        <div key={cat.id} className="bg-white p-3 rounded-xl border border-slate-100 shadow-sm flex justify-between items-center">
                                            <span className="font-bold text-slate-700">{cat.name}</span>
                                            <button onClick={() => handleDeleteIncome(cat.id)} className="text-slate-300 hover:text-red-400"><Trash2 size={16} /></button>
                                        </div>
                                    ))}
                                </div>
                            </>
                        )}
                    </div>
                </div>
            );
        };

        const MoneySection = ({ transactions, setTransactions, expenseCategories, setExpenseCategories, incomeCategories, setIncomeCategories }) => {
          const [tab, setTab] = useState('log');
          const [viewMode, setViewMode] = useState('month');
          const [amount, setAmount] = useState('');
          const [currency, setCurrency] = useState(Currency.GBP);
          const [transType, setTransType] = useState(TransactionType.EXPENSE);
          const [category, setCategory] = useState(expenseCategories[0]?.name || 'General');
          const [viewDate, setViewDate] = useState(new Date());
          const [showSettings, setShowSettings] = useState(false);

          // Update default category when type switches
          useEffect(() => {
              if (transType === TransactionType.EXPENSE && expenseCategories.length > 0) {
                  setCategory(expenseCategories[0].name);
              } else if (transType === TransactionType.INCOME && incomeCategories.length > 0) {
                  setCategory(incomeCategories[0].name);
              }
          }, [transType]);

          const handleDateChange = (offset) => {
            const newDate = new Date(viewDate);
            if (viewMode === 'month') {
                newDate.setMonth(newDate.getMonth() + offset);
            } else {
                newDate.setFullYear(newDate.getFullYear() + offset);
            }
            setViewDate(newDate);
          };

          const handleSubmit = (e) => {
            e.preventDefault();
            if (!amount) return;

            const val = parseFloat(amount);
            const newTrans = {
              id: Date.now().toString(),
              date: new Date().toISOString(),
              type: transType,
              originalAmount: val,
              originalCurrency: currency,
              amount: currency === Currency.HKD ? val * EXCHANGE_RATE_HKD_TO_GBP : val,
              category: category,
            };

            setTransactions([newTrans, ...transactions]);
            setAmount('');
          };

          const handleDeleteTransaction = (id) => {
              // Delete directly without confirmation
              setTransactions(transactions.filter(t => t.id !== id));
          };

          const activeCategories = transType === TransactionType.INCOME ? incomeCategories : expenseCategories;

          const stats = useMemo(() => {
            const filtered = transactions.filter(t => {
              const d = new Date(t.date);
              if (viewMode === 'month') {
                return d.getMonth() === viewDate.getMonth() && d.getFullYear() === viewDate.getFullYear();
              } else {
                return d.getFullYear() === viewDate.getFullYear();
              }
            });

            const income = filtered
              .filter(t => t.type === TransactionType.INCOME)
              .reduce((sum, t) => sum + t.amount, 0);
              
            const expense = filtered
              .filter(t => t.type === TransactionType.EXPENSE)
              .reduce((sum, t) => sum + t.amount, 0);

            return { income, expense, balance: income - expense, filtered };
          }, [transactions, viewDate, viewMode]);

          if (showSettings) {
              return (
                <ManageCategories 
                    expenseCategories={expenseCategories} 
                    setExpenseCategories={setExpenseCategories}
                    incomeCategories={incomeCategories}
                    setIncomeCategories={setIncomeCategories}
                    onClose={() => setShowSettings(false)}
                    transactions={transactions}
                />
              );
          }

          return (
            <div className="space-y-6">
              <div className="flex flex-col gap-3">
                <div className="flex justify-between items-end">
                    <button 
                        onClick={() => setShowSettings(true)}
                        className="flex items-center gap-1 text-xs font-bold text-slate-500 bg-slate-100 px-3 py-1.5 rounded-lg hover:bg-slate-200"
                    >
                        <Settings size={14} /> Categories
                    </button>

                    <div className="bg-slate-100 p-1 rounded-lg flex text-xs font-medium">
                        <button 
                            onClick={() => setViewMode('month')}
                            className={`px-3 py-1 rounded-md transition-all ${viewMode === 'month' ? 'bg-white text-slate-800 shadow-sm' : 'text-slate-400'}`}
                        >
                            Monthly
                        </button>
                        <button 
                            onClick={() => setViewMode('year')}
                            className={`px-3 py-1 rounded-md transition-all ${viewMode === 'year' ? 'bg-white text-slate-800 shadow-sm' : 'text-slate-400'}`}
                        >
                            Yearly
                        </button>
                    </div>
                </div>

                <div className="flex justify-between items-center bg-white p-2 rounded-xl shadow-sm border border-slate-100">
                  <button onClick={() => handleDateChange(-1)} className="p-2 hover:bg-slate-100 rounded-lg text-slate-400 hover:text-slate-600">â†</button>
                  <span className="font-bold text-slate-700">
                      {viewMode === 'month' 
                          ? viewDate.toLocaleString('default', { month: 'long', year: 'numeric' })
                          : viewDate.getFullYear()
                      }
                  </span>
                  <button onClick={() => handleDateChange(1)} className="p-2 hover:bg-slate-100 rounded-lg text-slate-400 hover:text-slate-600">â†’</button>
                </div>
              </div>

              <div className="flex bg-slate-200 p-1 rounded-xl">
                <button
                  onClick={() => setTab('log')}
                  className={`flex-1 py-2 rounded-lg text-sm font-bold transition-all ${tab === 'log' ? 'bg-white shadow text-slate-800' : 'text-slate-500'}`}
                >
                  Transactions
                </button>
                <button
                  onClick={() => setTab('summary')}
                  className={`flex-1 py-2 rounded-lg text-sm font-bold transition-all ${tab === 'summary' ? 'bg-white shadow text-slate-800' : 'text-slate-500'}`}
                >
                  Visualization
                </button>
              </div>

              {tab === 'log' ? (
                <>
                  <div className="grid grid-cols-3 gap-2">
                    <div className="bg-green-100 p-3 rounded-xl border border-green-200">
                      <p className="text-green-600 text-[10px] font-bold uppercase">In</p>
                      <p className="text-green-800 font-bold text-lg">Â£{stats.income.toFixed(0)}</p>
                    </div>
                    <div className="bg-red-100 p-3 rounded-xl border border-red-200">
                      <p className="text-red-600 text-[10px] font-bold uppercase">Out</p>
                      <p className="text-red-800 font-bold text-lg">Â£{stats.expense.toFixed(0)}</p>
                    </div>
                     <div className="bg-slate-100 p-3 rounded-xl border border-slate-200">
                      <p className="text-slate-600 text-[10px] font-bold uppercase">Net</p>
                      <p className={`font-bold text-lg ${stats.balance >= 0 ? 'text-slate-800' : 'text-red-500'}`}>Â£{stats.balance.toFixed(0)}</p>
                    </div>
                  </div>

                  <div className="bg-white rounded-2xl p-6 shadow-sm border border-pink-100">
                    <div className="flex gap-2 mb-4">
                       <button onClick={() => { setTransType(TransactionType.EXPENSE); }} className={`flex-1 py-2 rounded-lg font-bold text-sm ${transType === TransactionType.EXPENSE ? 'bg-pink-400 text-white' : 'bg-slate-100 text-slate-400'}`}>Expense</button>
                       <button onClick={() => { setTransType(TransactionType.INCOME); }} className={`flex-1 py-2 rounded-lg font-bold text-sm ${transType === TransactionType.INCOME ? 'bg-green-400 text-white' : 'bg-slate-100 text-slate-400'}`}>Income</button>
                    </div>

                    <form onSubmit={handleSubmit} className="space-y-4">
                      <div className="flex gap-2">
                         <div className="relative flex-1">
                            <input
                              type="number"
                              step="0.01"
                              value={amount}
                              onChange={(e) => setAmount(e.target.value)}
                              placeholder="0.00"
                              className="w-full pl-8 pr-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-pink-300"
                            />
                            <span className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400">
                                {currency === Currency.GBP ? 'Â£' : '$'}
                            </span>
                         </div>
                         <select
                            value={currency}
                            onChange={(e) => setCurrency(e.target.value)}
                            className="bg-slate-100 rounded-xl px-3 font-medium text-slate-600 focus:outline-none"
                         >
                            <option value={Currency.GBP}>GBP</option>
                            <option value={Currency.HKD}>HKD</option>
                         </select>
                      </div>

                      <div className="grid grid-cols-2 gap-2">
                        {activeCategories.map(cat => (
                          <button
                            key={cat.id}
                            type="button"
                            onClick={() => setCategory(cat.name)}
                            className={`p-2 text-xs rounded-lg border transition-all truncate ${
                              category === cat.name
                                ? 'bg-slate-800 text-white border-slate-800'
                                : 'border-slate-200 text-slate-500 hover:bg-slate-50'
                            }`}
                          >
                            {cat.name}
                          </button>
                        ))}
                      </div>

                      <button type="submit" className="w-full bg-slate-900 text-white py-3 rounded-xl font-bold flex items-center justify-center gap-2 shadow-lg">
                        <Plus size={18} /> Add {transType}
                      </button>
                    </form>
                  </div>
                  
                  <div className="space-y-2">
                    {stats.filtered.map(t => (
                       <div key={t.id} className="flex justify-between items-center bg-white p-3 rounded-xl border border-slate-50 shadow-sm">
                          <div className="flex items-center gap-3">
                             <div className={`p-2 rounded-full ${t.type === TransactionType.INCOME ? 'bg-green-100 text-green-600' : 'bg-pink-100 text-pink-600'}`}>
                                {t.type === TransactionType.INCOME ? <Coins size={16} /> : <PoundSterling size={16} />}
                             </div>
                             <div>
                                <p className="font-semibold text-slate-700 text-sm">{t.category}</p>
                                <p className="text-xs text-slate-400">{new Date(t.date).toLocaleDateString()}</p>
                             </div>
                          </div>
                          <div className="flex items-center gap-3">
                            <div className="text-right">
                                <p className={`font-bold ${t.type === TransactionType.INCOME ? 'text-green-600' : 'text-slate-800'}`}>
                                    {t.type === TransactionType.INCOME ? '+' : '-'} {t.originalCurrency === Currency.GBP ? 'Â£' : 'HK$'}{t.originalAmount}
                                </p>
                                {t.originalCurrency === Currency.HKD && (
                                    <p className="text-[10px] text-slate-400">â‰ˆ Â£{t.amount.toFixed(2)}</p>
                                )}
                            </div>
                            <button onClick={() => handleDeleteTransaction(t.id)} className="text-slate-300 hover:text-red-400 p-1">
                                <Trash2 size={16} />
                            </button>
                          </div>
                       </div>
                    ))}
                    {stats.filtered.length === 0 && <p className="text-center text-slate-400 text-sm py-4">No transactions found for this period.</p>}
                  </div>
                </>
              ) : (
                <MoneyVisualization 
                    transactions={transactions} 
                    currentMonth={viewDate.getMonth()} 
                    currentYear={viewDate.getFullYear()} 
                    viewMode={viewMode}
                    expenseCategories={expenseCategories}
                />
              )}
            </div>
          );
        };

        const PondRow = ({ pond, onUpdateDroplets, onSetDroplets, onDelete }) => {
            const [inputValue, setInputValue] = useState(pond.droplets.toString());

            useEffect(() => {
                setInputValue(pond.droplets.toString());
            }, [pond.droplets]);

            const handleChange = (e) => {
                const val = e.target.value;
                setInputValue(val);

                if (val === '' || val === '-') return;

                const num = parseInt(val);
                if (!isNaN(num)) {
                    onSetDroplets(pond.id, num);
                }
            };

            return (
                <div className="bg-white rounded-2xl p-5 shadow-sm border border-slate-100 relative overflow-hidden group">
                    <div className="absolute right-0 bottom-0 opacity-5 pointer-events-none">
                      <Droplets size={120} />
                    </div>

                    <div className="relative z-10">
                      <div className="flex justify-between items-start mb-4">
                        <h3 className="text-lg font-bold text-slate-700">{pond.name}</h3>
                        <button 
                          onClick={() => onDelete(pond.id)}
                          className="text-slate-300 hover:text-red-400 transition-colors p-1"
                        >
                          <Trash2 size={16} />
                        </button>
                      </div>

                      <div className="flex items-end justify-between">
                        <div className="flex items-center gap-2 bg-slate-50 rounded-xl p-1">
                          <button
                            onClick={() => onUpdateDroplets(pond.id, -1)}
                            className="w-10 h-10 flex items-center justify-center bg-white rounded-lg shadow-sm text-slate-400 hover:text-slate-600 hover:shadow active:scale-95 transition-all"
                          >
                            <Minus size={18} />
                          </button>
                          
                          <input 
                            type="text" 
                            inputMode="numeric"
                            value={inputValue} 
                            onChange={handleChange}
                            className={`w-16 h-10 text-center font-bold text-xl bg-transparent focus:outline-none focus:ring-2 focus:ring-sky-200 rounded-md ${pond.droplets < 0 ? 'text-red-500' : 'text-sky-600'}`}
                          />

                          <button
                            onClick={() => onUpdateDroplets(pond.id, 1)}
                            className="w-10 h-10 flex items-center justify-center bg-sky-500 rounded-lg shadow-sm text-white hover:bg-sky-600 hover:shadow-md active:scale-95 transition-all"
                          >
                            <Plus size={18} />
                          </button>
                        </div>
                        
                        <div className="flex gap-1 pointer-events-none">
                          {pond.droplets >= 0 ? (
                              Array.from({ length: Math.min(5, pond.droplets) }).map((_, i) => (
                                <Droplets 
                                  key={i} 
                                  size={16} 
                                  className={`text-sky-400 ${i === 4 && pond.droplets > 5 ? 'opacity-50' : 'fill-sky-400'}`} 
                                />
                              ))
                          ) : (
                               <span className="text-xs text-red-400 font-bold px-2 py-1 bg-red-50 rounded">Overdraft</span>
                          )}
                          {pond.droplets > 5 && <span className="text-xs text-sky-400 font-bold">...</span>}
                        </div>
                      </div>
                    </div>
                    
                    {pond.droplets > 0 && (
                        <div className="absolute bottom-0 left-0 h-1 bg-sky-500 transition-all duration-500" style={{ width: `${Math.min(100, pond.droplets * 2)}%` }} />
                    )}
                    {pond.droplets < 0 && (
                        <div className="absolute bottom-0 left-0 h-1 bg-red-400 w-full opacity-50" />
                    )}
                </div>
            );
        };

        const BankSection = ({ ponds, setPonds }) => {
          const [newPondName, setNewPondName] = useState('');

          const handleAddPond = (e) => {
            e.preventDefault();
            if (!newPondName.trim()) return;

            const newPond = {
              id: Date.now().toString(),
              name: newPondName.trim(),
              droplets: 0,
            };

            setPonds([newPond, ...ponds]);
            setNewPondName('');
          };

          const updateDroplets = (id, delta) => {
            setPonds(ponds.map(pond => {
              if (pond.id === id) {
                const newCount = pond.droplets + delta;
                return { ...pond, droplets: newCount };
              }
              return pond;
            }));
          };

          const setDropletsValue = (id, value) => {
            setPonds(ponds.map(pond => {
              if (pond.id === id) {
                return { ...pond, droplets: value };
              }
              return pond;
            }));
          };

          const deletePond = (id) => {
            setPonds(ponds.filter(p => p.id !== id));
          };

          return (
            <div className="space-y-6">
              <div className="bg-gradient-to-r from-sky-500 to-blue-600 rounded-2xl p-6 text-white shadow-lg shadow-sky-200">
                <h2 className="text-xl font-bold flex items-center gap-2">
                  <Droplets className="fill-white" />
                  Droplet Savings
                </h2>
                <p className="opacity-90 text-sm mt-1">Collect your savings in different ponds.</p>
                <p className="text-3xl font-bold mt-4">
                  {ponds.reduce((acc, curr) => acc + curr.droplets, 0)}
                  <span className="text-base font-normal opacity-75 ml-2">total droplets</span>
                </p>
              </div>

              <div className="bg-white rounded-2xl p-6 shadow-sm border border-slate-100">
                <h3 className="text-sm font-bold text-slate-700 mb-3 uppercase tracking-wider">Create New Pond</h3>
                <form onSubmit={handleAddPond} className="flex gap-2">
                  <input
                    type="text"
                    value={newPondName}
                    onChange={(e) => setNewPondName(e.target.value)}
                    placeholder="e.g. Trip to Japan, New Laptop..."
                    className="flex-1 px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-sky-300 transition-all text-sm"
                  />
                  <button
                    type="submit"
                    disabled={!newPondName.trim()}
                    className="bg-sky-500 hover:bg-sky-600 disabled:opacity-50 text-white p-3 rounded-xl transition-colors shadow-lg shadow-sky-100"
                  >
                    <Plus size={20} />
                  </button>
                </form>
              </div>

              <div className="space-y-4">
                {ponds.map((pond) => (
                  <PondRow 
                    key={pond.id} 
                    pond={pond} 
                    onUpdateDroplets={updateDroplets} 
                    onSetDroplets={setDropletsValue}
                    onDelete={deletePond}
                  />
                ))}

                {ponds.length === 0 && (
                  <div className="text-center py-10 opacity-50">
                    <Droplets size={48} className="mx-auto mb-2 text-slate-300" />
                    <p className="text-slate-400">No ponds created yet.</p>
                  </div>
                )}
              </div>
            </div>
          );
        };

        const SummaryModule = ({ weightLogs, dietLogs, exerciseLogs, transactions }) => {
          const currentMonth = new Date().getMonth();
          
          const thisMonthExercise = exerciseLogs.filter(l => new Date(l.date).getMonth() === currentMonth);
          const totalMins = thisMonthExercise.reduce((sum, l) => sum + l.durationMinutes, 0);

          const thisMonthDiet = dietLogs.filter(l => new Date(l.date).getMonth() === currentMonth);
          const healthyMeals = thisMonthDiet.filter(l => 
            l.vegetableBowls >= 1 && 
            (l.sauce === SauceAmount.NONE || l.sauce === SauceAmount.LITTLE) &&
            !l.hasColdDrink && 
            !l.hasSugarDrink
          ).length;

          const latestWeight = weightLogs.length > 0 ? weightLogs[0].weight : 'N/A';

          const thisMonthMoney = transactions.filter(l => new Date(l.date).getMonth() === currentMonth);
          const income = thisMonthMoney.filter(t => t.type === TransactionType.INCOME).reduce((s, t) => s + t.amount, 0);
          const expense = thisMonthMoney.filter(t => t.type === TransactionType.EXPENSE).reduce((s, t) => s + t.amount, 0);

          return (
            <div className="space-y-4">
              <div className="bg-gradient-to-br from-pink-400 to-pink-500 rounded-2xl p-6 text-white shadow-lg shadow-pink-200">
                <h2 className="text-2xl font-bold mb-1">Hello, Fat Boy!</h2>
                <p className="opacity-90">Keep pushing your limits this month.</p>
              </div>

              <div className="grid grid-cols-2 gap-4">
                <div className="bg-white p-4 rounded-2xl shadow-sm border border-slate-100">
                   <p className="text-slate-400 text-xs font-bold uppercase">Weight</p>
                   <p className="text-2xl font-bold text-slate-700">{latestWeight} <span className="text-sm">kg</span></p>
                </div>
                <div className="bg-white p-4 rounded-2xl shadow-sm border border-slate-100">
                   <p className="text-slate-400 text-xs font-bold uppercase">Active Mins</p>
                   <p className="text-2xl font-bold text-sky-500">{totalMins}</p>
                </div>
                <div className="bg-white p-4 rounded-2xl shadow-sm border border-slate-100">
                   <p className="text-slate-400 text-xs font-bold uppercase">Healthy Meals</p>
                   <p className="text-2xl font-bold text-green-500">{healthyMeals} <span className="text-sm text-slate-400">/ {thisMonthDiet.length}</span></p>
                </div>
                <div className="bg-white p-4 rounded-2xl shadow-sm border border-slate-100">
                   <p className="text-slate-400 text-xs font-bold uppercase">Savings</p>
                   <p className="text-2xl font-bold text-indigo-500">Â£{(income - expense).toFixed(0)}</p>
                </div>
              </div>

              <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                <h3 className="font-bold text-slate-700 mb-2">Mom's Message</h3>
                <p className="text-slate-500 italic text-sm">"Remember to eat more vegetables and save money for your future! Love you!"</p>
              </div>
            </div>
          );
        };

        const DEFAULT_EXPENSE_CATEGORIES = [
          { id: 'meals', name: 'Meals', warning: 500, danger: 800 },
          { id: 'transport', name: 'Transport', warning: 200, danger: 400 },
          { id: 'accommodation', name: 'Accommodation', warning: 800, danger: 1200 },
          { id: 'travelling', name: 'Travelling', warning: 300, danger: 600 },
          { id: 'leisure', name: 'Leisure', warning: 100, danger: 300 },
          { id: 'back_home', name: 'Back Home', warning: 2000, danger: 3000 },
        ];

        const DEFAULT_INCOME_CATEGORIES = [
          { id: 'pocket', name: 'Pocket Money' },
          { id: 'part_time', name: 'Part Time' },
          { id: 'interest', name: 'Interest' },
          { id: 'other', name: 'Other' },
        ];

        const App = () => {
          const [activeTab, setActiveTab] = useStorage('active_tab', 'summary');
          
          const [weightLogs, setWeightLogs] = useStorage('weight_logs', []);
          const [dietLogs, setDietLogs] = useStorage('diet_logs', []);
          const [exerciseLogs, setExerciseLogs] = useStorage('exercise_logs', []);
          const [transactions, setTransactions] = useStorage('money_logs', []);
          const [ponds, setPonds] = useStorage('bank_ponds', []);

          // New configurable state
          const [expenseCategories, setExpenseCategories] = useStorage('expense_cats', DEFAULT_EXPENSE_CATEGORIES);
          const [incomeCategories, setIncomeCategories] = useStorage('income_cats', DEFAULT_INCOME_CATEGORIES);

          const [alert, setAlert] = useState(null);

          useEffect(() => {
            if (weightLogs.length > 0) {
              const lastWeight = new Date(weightLogs[0].date).getTime();
              const now = Date.now();
              const diffDays = (now - lastWeight) / (1000 * 60 * 60 * 24);
              if (diffDays > 3) {
                setAlert("âš ï¸ It's been over 3 days! Please weigh yourself.");
              } else {
                setAlert(null);
              }
            }
          }, [weightLogs]);

          const renderContent = () => {
            switch (activeTab) {
              case 'summary':
                return <SummaryModule 
                    weightLogs={weightLogs}
                    dietLogs={dietLogs}
                    exerciseLogs={exerciseLogs}
                    transactions={transactions}
                />;
              case 'weight':
                return <WeightSection logs={weightLogs} setLogs={setWeightLogs} />;
              case 'diet':
                return <DietSection logs={dietLogs} setLogs={setDietLogs} />;
              case 'exercise':
                return <ExerciseSection logs={exerciseLogs} setLogs={setExerciseLogs} />;
              case 'money':
                return <MoneySection 
                    transactions={transactions} 
                    setTransactions={setTransactions} 
                    expenseCategories={expenseCategories}
                    setExpenseCategories={setExpenseCategories}
                    incomeCategories={incomeCategories}
                    setIncomeCategories={setIncomeCategories}
                />;
              case 'bank':
                return <BankSection ponds={ponds} setPonds={setPonds} />;
              default:
                return <SummaryModule 
                    weightLogs={weightLogs}
                    dietLogs={dietLogs}
                    exerciseLogs={exerciseLogs}
                    transactions={transactions}
                />;
            }
          };

          return (
            <Layout activeTab={activeTab} onTabChange={setActiveTab} alert={alert}>
              {activeTab !== 'summary' && (
                  <div className="mb-6">
                      <h2 className="text-2xl font-bold text-slate-800 capitalize">{activeTab}</h2>
                      <p className="text-slate-400 text-sm">Track your progress</p>
                  </div>
              )}
              {renderContent()}
            </Layout>
          );
        };

        const container = document.getElementById('root');
        if (container) {
          const root = createRoot(container);
          root.render(<App />);
        }
    </script>
</body>
</html>
